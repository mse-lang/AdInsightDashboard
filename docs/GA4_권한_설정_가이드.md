# Google Analytics 4 권한 설정 가이드

VS-AMS 시스템에서 Google Analytics 데이터를 가져오려면 서비스 계정에 GA4 속성 접근 권한을 부여해야 합니다.

## ✅ 현재 설정 상태

- ✅ 서비스 계정 생성됨
- ✅ 환경 변수 설정됨 (GA_CREDENTIALS, GA_PROPERTY_ID)
- ❌ **GA4 속성 접근 권한 없음** ← 이 부분을 설정해야 합니다

---

## 📋 서비스 계정 정보

**서비스 계정 이메일:**
```
ad-tracker-services@ad-tracker-476219.iam.gserviceaccount.com
```

**GA4 속성 ID:**
```
356388728
```

**⚠️ 주의:** 위 이메일을 정확히 복사하세요! (띄어쓰기나 오타가 있으면 안 됩니다)

---

## 🔧 권한 추가 방법 (단계별)

### 1단계: Google Analytics 접속
1. **https://analytics.google.com** 접속
2. 벤처스퀘어 계정으로 로그인 (mj@venturesquare.net 또는 관리자 계정)

### 2단계: 속성 관리 페이지 이동
1. 좌측 하단의 **⚙️ (관리)** 아이콘 클릭
2. "계정" 열에서 벤처스퀘어 계정 선택 (이미 선택되어 있을 수 있음)
3. "속성" 열에서 대상 GA4 속성 선택

### 3단계: 속성 액세스 관리
1. "속성" 열 아래에서 **"속성 액세스 관리"** 클릭
2. 현재 접근 권한이 있는 사용자 목록이 표시됩니다

### 4단계: 서비스 계정 추가
1. 우측 상단의 **파란색 "+" 버튼** 클릭
2. **"사용자 추가"** 선택

### 5단계: 이메일 입력 및 역할 선택
1. "이메일 주소" 입력란에 다음을 **정확히 복사해서 붙여넣기:**
   ```
   ad-tracker-services@ad-tracker-476219.iam.gserviceaccount.com
   ```

2. "역할" 드롭다운에서 다음 중 하나 선택:
   - ✅ **뷰어** (권장) - 데이터 읽기만 가능
   - ⚠️ 분석가 - 더 많은 권한 (필요 없음)
   - ❌ 편집자/관리자 - 너무 많은 권한 (사용하지 마세요)

3. "사용자에게 이메일로 알림" 체크박스는 **해제**해도 됩니다
   (서비스 계정은 이메일을 받지 않습니다)

### 6단계: 추가 완료
1. 우측 상단 **"추가"** 버튼 클릭
2. 사용자 목록에 서비스 계정 이메일이 추가된 것을 확인

---

## 🧪 권한 확인 및 테스트

### 방법 1: 터미널에서 테스트
Replit 터미널에서 다음 명령어를 실행하세요:

```bash
npx tsx scripts/test-ga-connection.ts
```

**성공 시 출력:**
```
✅ Google Analytics API 연결 성공!

최근 30일 데이터:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 페이지뷰: 45,892
👥 활성 사용자: 23,451
⏱️  평균 체류시간: 3분 24초
📉 이탈률: 42.3%
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 Google Analytics 연결이 정상적으로 작동합니다!
```

**실패 시 출력 (권한 없음):**
```
❌ Google Analytics API 오류:
{
  "error": {
    "code": 403,
    "message": "User does not have sufficient permissions..."
  }
}
```

→ 이 경우, 위 단계를 다시 확인하세요.

### 방법 2: 웹 애플리케이션에서 확인
1. VS-AMS 애플리케이션 접속
2. 좌측 사이드바에서 **"성과 분석"** 클릭
3. **"웹 분석"** 탭 선택
4. 다음을 확인:
   - ✅ "Google Analytics 실시간 연동" 표시
   - ✅ 실제 페이지뷰, 사용자 수, 체류시간 데이터 표시
   - ❌ "데모 데이터를 표시하고 있습니다" 알림 **없음**

---

## 🔍 문제 해결

### 문제 1: "사용자 추가" 버튼이 보이지 않음
**원인:** 속성에 대한 관리자 권한이 없습니다.

**해결:**
- mj@venturesquare.net 또는 rosie@venturesquare.net 등 관리자 계정으로 로그인
- 또는 기존 관리자에게 권한 추가 요청

### 문제 2: 서비스 계정 이메일 입력 시 오류
**원인:** 이메일 형식이 올바르지 않거나 오타가 있습니다.

**해결:**
- 위의 이메일을 정확히 복사/붙여넣기
- 띄어쓰기나 특수문자가 추가되지 않았는지 확인
- `@ad-tracker-476219.iam.gserviceaccount.com` 도메인이 정확한지 확인

### 문제 3: 권한 추가 후에도 403 오류 발생
**원인:** 권한 적용에 시간이 걸리거나, 잘못된 속성에 추가했을 수 있습니다.

**해결:**
1. 5분 정도 기다린 후 다시 테스트
2. GA4 속성 ID가 `356388728`이 맞는지 확인
3. 올바른 속성에 권한을 추가했는지 재확인

### 문제 4: 여러 GA4 속성이 있어서 어떤 것인지 모르겠음
**해결:**
1. Google Analytics 관리 페이지에서 각 속성 클릭
2. 속성 설정에서 속성 ID 확인
3. `356388728`과 일치하는 속성 찾기

---

## 📚 추가 참고사항

### 보안 고려사항
- 서비스 계정은 **뷰어** 역할만 부여하세요
- 편집자나 관리자 권한은 불필요하며 보안 위험이 있습니다
- 서비스 계정은 읽기 전용으로만 사용됩니다

### 권한 유지
- 서비스 계정 권한은 영구적으로 유지됩니다
- 삭제하지 않는 한 계속 사용 가능합니다
- 정기적으로 권한을 검토하는 것이 좋습니다

### 데이터 범위
- API는 최근 30일 데이터를 기본으로 가져옵니다
- 필요시 날짜 범위를 조정할 수 있습니다
- 실시간 데이터는 15분~1시간 지연될 수 있습니다

---

## ✅ 완료 체크리스트

권한 설정이 완료되었는지 확인하세요:

- [ ] Google Analytics 관리 페이지 접속 완료
- [ ] 올바른 GA4 속성 선택 (속성 ID: 356388728)
- [ ] 속성 액세스 관리 페이지 접속
- [ ] 서비스 계정 이메일 정확히 입력
- [ ] "뷰어" 역할 선택
- [ ] 사용자 추가 완료
- [ ] 터미널 테스트 명령어 실행 (npx tsx scripts/test-ga-connection.ts)
- [ ] 테스트 성공 메시지 확인
- [ ] 웹 애플리케이션에서 실제 데이터 확인

---

**작성일:** 2025-11-16  
**문의:** VS-AMS 개발팀

권한 추가 후 문제가 계속되면 개발팀에 문의하세요.
